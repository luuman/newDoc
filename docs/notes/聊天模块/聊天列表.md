---
tag:
  - 草稿
  - 消息提示
  - 未读数
---

# ChatsPanel

```mermaid
stateDiagram-v2
	Bus --> initInfo: do-init-mix
	mounted --> initInfo: 刷新通讯录合群组
	activated --> activedForChatFn: 聊天列表置地
	created --> mangePeerList: 拉取个人信息
	mangePeerList --> setUserInfo
	setUserInfo --> SET_USER_INFO
```

初始化 UserInfo

```
Main
	ChatsPanel
		SessionList
		MessageBox
```

# 消息提示

1. 消息列表中，当有@我消息时，显示[@me],当有@all 消息时，显示[@all]
1.

```mermaid
stateDiagram-v2
	A: 其他
	A1: [@all]
	A2: [@me]
	A3: 拼接...
	A4: ...
	A5: 失败
	B: 草稿
	B1: [@all]
	B2: [@me]
	B3: 拼接[Draft](draft)
	B4: ...
    MessageTip --> A
    MessageTip --> B
    B --> B1: all
    B --> B2: me
    B --> B4: none
    B4 --> B3
    B2 --> B3
    B1 --> B3
	A --> A1: all
    A --> A2: me
    A --> A4: none
	A --> A5: 发送失败ICON
	A5 --> A3
	A4 --> A3
    A2 --> A3
    A1 --> A3
	A6: Failed to decrypt this message
	A3 --> A6: 解密失败
	A7: {{发送人：}}  [Contact Card]
	A6 --> A7: 联系人卡片
	A8: {{自己：}} deleted a message
	A7 --> A8: 删除消息
	A9: {{发送人：}} {{会议标题}}
	A8 --> A9: 会议邀请
	A10: {{会议标题}}
	A9 --> A10: 会议卡片
	A11: Your security code with {{发送人}} has changed. Click to
	A10 --> A11: E2E
	A12: {{发送人：}} [File] {{文件名称}}
	A11 --> A12: 文件名称
	A13: {{发送人：}} {{getRestrictedText()}}
	A12 --> A13: 受限制文案
	A14: {{发送人：}} [Photo]
	A13 --> A14: 图片名称
	A15: [Audio] {{语音时间}}
	A14 --> A15: 语音
	A16: [Audio] {{语音时间}}
	A15 --> A16: 自己的语音
	A17: {{发送人：}} {{消息内容}}
	A16 --> A17: 消息
	A18: {{发送人：}} [{{recordtxt()}}]
	A17 --> A18: 通话
```

# 草稿

## 流程

1. 草稿实时节流缓存，接收到消息清除缓存
1. 切换会话，检测更新会话
1. 发送（会议卡片、消息）清除缓存
1. 漏洞：编辑草稿的时间早于操作时间（拉取成员）
1. 监听到草稿，更新数据库（value 和 time），切换时候才判断是否需要更新列表时间戳（时间是否 lastReactTime 大于）
1. 处于当前会话不展示草稿

> 输入框-防抖更新草稿

```mermaid
stateDiagram
  classDef notMoving fill:#d22778,color:white,font-weight:bold,stroke:#15647b
	selectMemberHandle:::notMoving
	doubleContactCard:::notMoving
	handleUndo:::notMoving
	pasteHandle:::notMoving
	emojiSelected:::notMoving
	checkAutocomplete:::notMoving
	state MessageInput.vue {
		selectMemberHandle --> onInputChange: @成员
		doubleContactCard --> onInputChange: 未知
		handleUndo --> onInputChange: 撤销
		pasteHandle --> onInputChange: 文件复制，粘贴
		emojiSelected --> onInputChange: 表情输入
		checkAutocomplete --> onInputChange: 输入
	}
	onInputChange --> changeDraft: debounce
```

> 切换聊天列表

```mermaid
stateDiagram-v2
  classDef notMoving fill:#d22778,color:white,font-weight:bold,stroke:#15647b
	state sessionList.vue {
		[*] --> chooseOne: 列表会话切换
		chooseOne --> ChangeLastReactTime
	}
	state uiControl.js {
		[*] --> switchOne: 其他方式切换
		switchOne --> ChangeLastReactTime
	}
	state ChangeLastReactTime {
		draftObj: let draftObj
		state if_state <<choice>>
		state if_state1 <<choice>>
		[*] --> draftObj
		draftObj --> if_state: 是否更新Session
		if_state --> if_state1: if lastReactTime < lastDraftTime 更新lastReactTime
		if_state --> if_state1: else
		if_state1 --> changeSession: if value 更新draftObj
		if_state1 --> changeSession: else 清除draftObj
		if_state --> [*]: else
		changeSession --> sessionCollection.js
	}
	state sessionCollection.js {
		[*] --> changeSession1
		changeSession1: changeSession
		changeSession1 --> actionDBSessionUpdate
		actionDBSessionUpdate
	}
	state sessionApi.js {
		actionDBSessionUpdate --> updateSingleSession
		updateSingleSession --> encodeSessionTransform
		state dataDao.js {
			encodeSessionTransform --> updateWith
		}
	}
```

> 发送消息清除草稿

```mermaid
stateDiagram-v2
	state ChangeLastReactTime {
		sendMeetingCardReplyMsg --> draft
		sendMsgHandle --> draft
		draft: F.draft
		draft --> sendMsgFromPannel
	}
```
